<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../common/message-dialog.html">


<dom-module id="register-form">
    <style>
        :host {
            display: block;
        }

        .colorful {
            background-color: #4285f4;
            color: #fff;
        }

        #form {
            width: 36em;
        }

        .message {
            margin-top: 0.5em;
            color: #e81719;
            font-size: 10px;
            text-align: center;
        }

    </style>
    <template>
        <form is="iron-form" id="form">
            <paper-input id="username" value={{user.user}} pattern="{{pattern.username}}" auto-validate="true"
                         error-message="Invalid Username" label="User Name"></paper-input>
            <paper-input id="firstname" value={{user.firstName}} label="First Name"></paper-input>
            <paper-input id="lastname" value={{user.lastName}} label="Last Name"></paper-input>
            <paper-input type="text" value={{user.email}} auto-validate="true" pattern="{{pattern.email}}"
                         error-message="Invalid E-Mail" id="email" label="E-Mail"></paper-input>
            <paper-input type="password" value={{user.password}} pattern="{{pattern.password}}" auto-validate="true"
                         error-message="Password too weak" id="password" label="Password"></paper-input>
            <paper-input id="confirmPassword" value="{{confirmPassword}}" on-input="verifyPassword" type="password"
                         pattern="{{pattern.confirmPassword}}" error-message="Passwords do not match"
                         label="Password Confirmation"></paper-input>
            <div class="centered-button-box">
                <paper-button raised role="button" on-click="goback">
                    <iron-icon icon="arrow-back"></iron-icon>
                    Go Back
                </paper-button>
                <paper-button raised role="button" class="colorful" on-click="register">
                    <iron-icon icon="check"></iron-icon>
                    Register
                </paper-button>
            </div>
        </form>
        </paper-material>

        <paper-toast id="toast" text="[[toastMessage]]"></paper-toast>
        <!--
        <message-dialog id="dialog" title="[[dialog.title]]" message="[[dialog.message]]"
                        cancel-text="[[dialog.cancelText]]" confirm-text="[[dialog.confirmText]]"></message-dialog>
                        -->
    </template>

    <script>
        (function () {
            "use strict";
            Polymer({
                is: 'register-form',

                properties: {
                    toastMessage : String,
                    user: {
                        type: Object,
                        notify: true,
                        value: {
                            domains : []
                        }
                    },
                    dialog: {
                        type: Object,
                        value: {}
                    },
                    pattern: {
                        type :Object,
                        value : {
                            email: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}",
                            username: "[a-zA-Z0-9._-]{6,16}",
                            password: ".{6}.*"
                        }
                    },
                    registerMessage: String
                },

                listeners: {
                    'iron-overlay-closed': 'onDialogClosed'
                },

                attached: function () {
                },

                verifyPassword: function (e) {
                    this.$.confirmPassword.invalid = e.target.value !== this.user.password;
                },

                onDialogClosed: function (e) {
                    if (e.target.closingReason.confirmed) {
                        this.goback();
                    }
                },

                goback: function () {
                    this.reset();
                    page('/login');
                },

                reset: function () {
                    this.user = { domains : [] };
                    this.confirmPassword = undefined;
                },

                register: function () {
                    var restapi = fermata.json(window.global.config.apiroot);
                    restapi('account').post(this.user, function (error, result) {
                        var registerMessage = {
                            user: "",
                            message: "Damn! Something went wrong."
                        };

                        if (!error) {
                            registerMessage.message = "Word! " + this.user.user + " registered successfully.";
                            registerMessage.user = this.user.user;
                            this.goback();
                        }

                        this.fire("registered", registerMessage);
                    }.bind(this));
                }
            });
        })();
    </script>

</dom-module>

