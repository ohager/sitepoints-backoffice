<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../common/message-dialog.html">


<dom-module id="register-form">
    <style>
        :host {
            display: block;
        }

        .colorful {
            background-color: #4285f4;
            color: #fff;
        }

        #form {
            width: 36em;
        }

        .message {
            margin-top: 0.5em;
            color: #e81719;
            font-size: 10px;
            text-align: center;
        }

    </style>
    <template>
        <form is="iron-form" id="form">
            <paper-input id="username" value={{user.user}} pattern="{{pattern.username}}" auto-validate="true"
                         error-message="Invalid Username" label="User Name"></paper-input>
            <paper-input id="domain" value={{user.domain}} label="Domain"></paper-input>
            <paper-input id="firstname" value={{user.firstName}} label="First Name"></paper-input>
            <paper-input id="lastname" value={{user.lastName}} label="Last Name"></paper-input>
            <paper-input type="text" value={{user.email}} auto-validate="true" pattern="{{pattern.email}}"
                         error-message="Invalid E-Mail" id="email" label="E-Mail"></paper-input>
            <paper-input type="password" value={{user.password}} pattern="{{pattern.password}}" auto-validate="true"
                         error-message="Password too weak" id="password" label="Password"></paper-input>
            <paper-input id="confirmPassword" value="{{confirmPassword}}" on-input="verifyPassword" type="password"
                         pattern="{{pattern.confirmPassword}}" error-message="Passwords do not match"
                         label="Password Confirmation"></paper-input>
            <div class="centered-button-box">
                <paper-button raised role="button" on-click="goback">
                    <iron-icon icon="arrow-back"></iron-icon>
                    Go Back
                </paper-button>
                <paper-button raised role="button" class="colorful" on-click="register">
                    <iron-icon icon="check"></iron-icon>
                    Register
                </paper-button>
            </div>
        </form>
        </paper-material>
        <message-dialog id="dialog" title="[[dialog.title]]" message="[[dialog.message]]"
                        cancel-text="[[dialog.cancelText]]" confirm-text="[[dialog.confirmText]]"></message-dialog>
    </template>

    <script>
        (function () {
            "use strict";
            Polymer({
                is: 'register-form',

                properties: {
                    user: {
                        type: Object,
                        notify: true,
                        value: {}
                    },
                    dialog: {
                        type: Object,
                        value: {}
                    },
                    pattern: Object,
                    registerMessage: String
                },

                listeners: {
                    'iron-overlay-closed': 'onDialogClosed'
                },

                attached: function () {
                    this.pattern = {
                        email: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}",
                        username: "[a-zA-Z0-9._-]{6,16}",
                        password: ".{6}.*"
                    };
                },

                verifyPassword: function (e) {
                    this.$.confirmPassword.invalid = e.target.value !== this.user.password;
                },

                onDialogClosed: function (e) {
                    if (e.target.closingReason.confirmed) {
                        this.goback();
                    }
                },

                goback: function () {
                    this.reset();
                    page('/login');
                },

                reset: function () {
                    this.user = {};
                    this.confirmPassword = undefined;
                },

                register: function () {
                    var restapi = fermata.json(window.global.config.apiroot);
                    restapi('account').post(this.user, function (error, result) {
                        if (!error) {
                            this.dialog = {
                                    title : "Yeah!",
                                    message: this.user.user + " registered successfully.",
                                    confirmText: "Go To Login",
                                    cancelText: ""
                                    };
                            this.reset();
                        }
                        else {
                            this.dialog = {
                                    title : "Damn! Something went wrong.",
                                    message:  error.message,
                                    confirmText: "",
                                    cancelText: "Try Again"
                                    };
                        }
                        this.$.dialog.open();
                    }.bind(this));
                }
            });
        })();
    </script>

</dom-module>

