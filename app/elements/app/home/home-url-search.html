<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="home-url-search">
    <style>
        :host {
        }

        paper-material {
            padding : 4px;
        }

        paper-dropdown-menu, paper-input {
            padding : 8px;
            vertical-align: middle;
            display: inline-block;
        }

        paper-input.large {
            width: 80%;
        }

        paper-icon-button {
            color: var(--paper-red-300);
            --paper-icon-button-ink-color: var(--paper-red-a100);
            --iron-icon-width: 15px;
            --iron-icon-height: 15px;
            padding: 0px 4px;
        }

        paper-menu {
            display: block;
        }

        .horizontal-section {
            text-align: center;
        }

    </style>
    <template>
        <paper-material elevation="1">
            <div class="flex">
                <paper-dropdown-menu id="domainSelector" label="Domains" placeholder="Select a domain">
                    <paper-menu class="dropdown-content" selected="0">
                        <template is="dom-repeat" items="[[domains]]" as="domain">
                            <paper-item>[[domain]]</paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu>

                <paper-input class="large" id="searchInput" label="Enter url pattern" on-input="search" value="{{searchTerm}}">
                    <iron-icon icon="search" prefix></iron-icon>
                    <paper-icon-button suffix on-click="clearSearch"
                                       icon="clear" alt="clear" title="clear" tabindex="0">
                    </paper-icon-button>
                </paper-input>
            </div>

            <template id="urlList" is="dom-repeat" items="[[urls]]" as="url">
                <paper-icon-item>
                    <paper-item-body class="flex">
                        <div class="label">[[url]]</div>
                    </paper-item-body>
                </paper-icon-item>
            </template>

        </paper-material>
    </template>

    <script>
        (function () {

            "use strict";
            Polymer({
                is: 'home-url-search',

                properties: {
                    searchTerm : {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    urls : {
                        type : Array,
                        value : []
                    },
                    domains : {
                        type : Array,
                        value : []
                    },
                    selectedDomain : String
                },

                searchTimer : null,

                clearSearch : function(){
                    this.searchTerm = "";
                    this.set('urls', []);
                },

                homeStoreChanged : function(data){
                    this.set('urls', data.urls.slice());
                },

                accountStoreChanged : function(account){
                    this.set('domains', account.domains.slice());
                },

                ready : function(){
                    NanoFlux.getStore('homeStore').subscribe(this, this.homeStoreChanged);
                    NanoFlux.getStore('accountStore').subscribe(this, this.accountStoreChanged);
                    NanoFlux.accountActions.load();
                },


                search : function(){

                    var domainSearchTerm = this.$.domainSelector.selectedItemLabel + "/" + this.searchTerm;

                    try{
                        new RegExp(domainSearchTerm);
                        this.$.searchInput.invalid = false;
                        this.$.searchInput.errorMessage = "";
                    }
                    catch(err){
                        this.$.searchInput.invalid = true;
                        this.$.searchInput.errorMessage = err.toString();
                        return;
                    }

                    if(this.searchTimer){
                        clearTimeout(this.searchTimer);
                    }

                    if(!this.searchTerm.length)
                    {
                        this.clearSearch();
                        return;
                    }

                    this.searchTimer = setTimeout(function(){
                        NanoFlux.homeActions.searchUrls(domainSearchTerm);
                    }.bind(this), 500)
                },

                click : function(e){
                    this.searchTerm = "";
                }

            });
        })();
    </script>

</dom-module>

